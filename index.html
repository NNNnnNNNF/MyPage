<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>占卜</title>
    <style>
        :root {
            --primary: #d4af37;
            --bg: #0f0f1a;
            --card-width: 100px;
            --card-height: 160px;
        }

        @media (min-width: 600px) {
            :root {
                --card-width: 120px;
                --card-height: 200px;
            }
        }

        body {
            font-family: 'Georgia', serif;
            background-color: var(--bg);
            background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #0f0f1a 100%);
            color: #ecf0f1;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        h1, h2, h3 { color: var(--primary); text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }

        .container {
            width: 90%;
            max-width: 1000px;
            padding: 20px;
            text-align: center;
        }

        .stage {
            height: 300px;
            width: 100%;
            position: relative;
            perspective: 1000px;
            margin-bottom: 50px;
        }

        .card-container {
            width: var(--card-width);
            height: var(--card-height);
            position: absolute;
            left: 50%;
            top: 50%;
            margin-left: calc(var(--card-width) / -2);
            margin-top: calc(var(--card-height) / -2);
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.6);
            z-index: 1;
        }

        .stage .card-container:hover {
            z-index: 100 !important;
            filter: brightness(1.2);
        }
        
        .result-card-visual {
            pointer-events: none;
            cursor: default;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            border: 2px solid #4a4a4a;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            background-color: #2c0e37;
        }

        .card-back {
            background-image: 
                radial-gradient(var(--primary) 15%, transparent 16%),
                linear-gradient(45deg, transparent 48%, var(--primary) 48%, var(--primary) 52%, transparent 52%),
                linear-gradient(-45deg, transparent 48%, var(--primary) 48%, var(--primary) 52%, transparent 52%);
            background-size: 20px 20px, 10px 10px, 10px 10px;
            border: 2px solid #5e3c6d;
        }
        
        .card-back::after {
            content: '';
            position: absolute;
            width: 60%;
            height: 40%;
            border: 2px solid var(--primary);
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            box-shadow: 0 0 10px var(--primary);
        }

        .card-front {
            background: #f4e4bc;
            color: #2c3e50;
            transform: rotateY(180deg);
            flex-direction: column;
            padding: 10px;
            border: 4px solid var(--primary);
        }

        .card-name { font-weight: bold; font-size: 0.9rem; margin-top: 5px; }
        .card-num { font-size: 0.8rem; color: #7f8c8d; }

        .flipped { transform: rotateY(180deg) !important; }
        .flipped-reversed { transform: rotateY(180deg) rotateZ(180deg) !important; }

        .shuffling-state { transition: transform 0.2s ease-in-out; }

        .btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 12px 40px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
            margin: 10px;
        }
        .btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 20px var(--primary); }
        .btn:disabled { border-color: #555; color: #555; cursor: not-allowed; box-shadow: none; }
        
        .hidden { display: none !important; }

        .result-box {
            text-align: left;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
            animation: slideIn 0.8s ease;
            max-height: 400px; 
            overflow-y: auto;
        }
        
        .result-card-visual {
            position: relative; left: auto; top: auto; margin: 0; transform: none;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .keyword-box {
            display: inline-block;
            background: rgba(212, 175, 55, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #ffeba7;
        }

        /* 倒计时提示样式 */
        .cooldown-info {
            color: #aaa;
            margin-top: 15px;
            font-style: italic;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Daily Tarot</h1>
        <p style="color: #888; font-style: italic;">每日一占，指引迷津</p>
    </header>

    <div id="section-start">
        <h3 style="margin-bottom: 30px;">占卜运势</h3>
        <p id="welcome-text">保持内心平静，默念你的问题</p>
        <button id="start-btn" class="btn" onclick="initGame()">开始抽取占卜指引</button>
        <div id="cooldown-timer" class="cooldown-info hidden"></div>
    </div>

    <div id="section-deck" class="hidden">
        <h3 id="instruction">洗牌中...</h3>
        <div class="stage" id="card-stage"></div>
    </div>

    <div id="section-result" class="hidden">
        <h3>命运启示</h3>
        <div id="result-content"></div>
        
        <div id="result-actions" style="margin-top: 20px;">
            <p id="result-cooldown-msg" class="cooldown-info"></p>
            <button id="restart-btn" class="btn hidden" onclick="location.reload()">新的占卜</button>
        </div>
    </div>
</div>

<script>
    /* === 塔罗数据 === */
   /* === 塔罗数据 (威力加强详尽版) === */
    const tarotData = [
        { 
            name: "愚者 (The Fool)", 
            num: "0", 
            desc_up: "此刻是无限可能性的起点，也是开启新旅程的绝佳契机。你正站在悬崖边，准备拥抱未知的冒险。这张牌告诉你：不要被过去的经验或他人的眼光束缚，保持一颗赤子之心。虽然在旁人眼中你可能有些天真甚至鲁莽，但你此刻的直觉比任何逻辑分析都更准确。大胆迈出第一步吧，不论是新的工作、新的恋情还是新的生活方式，宇宙都在支持你的‘傻劲’。", 
            desc_rev: "你可能正在逃避现实，或者在没有做好基础准备的情况下就盲目冒险。你以为的‘随性’可能只是‘鲁莽’。这张牌逆位时警告你：脚下的悬崖是真实的。请停下来检查你的装备和计划，不要为了改变而改变。另外，也要警惕那些听起来太美好而不切实际的幻想，现在的你容易因为冲动而做出后悔的决定。" 
        },
        { 
            name: "魔术师 (The Magician)", 
            num: "I", 
            desc_up: "正如魔术师将四元素摆在桌上，你现在已经拥有了达成目标所需的一切资源、技能和工具。这是一个关于‘显化’的时刻——你的所思所想，极有潜力转化为现实。你的沟通能力、创造力和意志力正处于巅峰状态。不要犹豫，现在就是行动的最佳时机。集中你的注意力，将你的才华展示出来，你完全有能力掌控局势并取得成功。", 
            desc_rev: "你可能感到才华无处施展，或者虽然拥有资源却不知道如何整合它们。这张牌逆位暗示了意志力的薄弱，或者计划在执行层面遇到了阻碍。更需要警惕的是，不要试图通过欺骗、操纵或走捷径来达到目的，那样建立起来的成功只是空中楼阁。请重新审视你的动机，沟通不畅可能是目前最大的绊脚石。" 
        },
        { 
            name: "女祭司 (The High Priestess)", 
            num: "II", 
            desc_up: "答案并不在喧嚣的外部世界，而在你静谧的内心深处。女祭司象征着潜意识、直觉和神秘的智慧。现在不是采取激进外在行动的时候，而是应该退后一步，冷静观察，倾听内在的声音。相信你的第六感，关注你的梦境，它们正在试图向你传达重要的信息。保持耐心，有些秘密会在最合适的时机自动向你揭晓。", 
            desc_rev: "你可能因为过于依赖逻辑分析而忽略了直觉的警告，或者相反，因为情绪过于泛滥而失去了理性的判断。这张牌逆位时，暗示你可能正在变得冷漠、封闭，拒绝与他人进行必要的交流。小心表面下的秘密被揭穿，或者你因为内心的不安而正在逃避面对真相。请试着重新建立与自己内心的连接。" 
        },
        { 
            name: "皇后 (The Empress)", 
            num: "III", 
            desc_up: "这是一张象征极致丰盛、母性与创造力的牌。无论是在物质财富还是情感关系上，你都将进入一个收获的季节。如果你正在策划一个新的项目，或者期待一段关系的开花结果，现在是最好的时机。去享受生活中的美、艺术和自然吧，宠爱你自己。你的温柔和包容将成为你最强大的力量，吸引来你想要的一切。", 
            desc_rev: "你可能在关系中变得过于依赖他人，或者控制欲过强，让人感到窒息。在物质层面，要警惕挥霍无度或过度追求奢侈享受。这张牌逆位也可能暗示了创造力的枯竭，你可能感到灵感受阻，或者在某个项目上停滞不前。你需要重新审视自己是否因为忽略了自我成长，而将过多的精力耗费在了无关紧要的人事物上。" 
        },
        { 
            name: "皇帝 (The Emperor)", 
            num: "IV", 
            desc_up: "局面尽在掌握。作为父权和威严的象征，这张牌要求你展现出领导力、决断力和逻辑思维。现在不是感情用事的时候，建立秩序、制定规则、脚踏实地地执行计划才是通往成功的路径。你可能遇到一位有权势的贵人，或者你自己需要成为那个掌舵的人。只有严密的规划和自律，才能巩固你目前的成就。", 
            desc_rev: "你需要警惕权力的滥用。你可能正在面对一个暴君般的上司或长辈，或者你自己正变得固执、专横且缺乏同情心。另一方面，逆位的皇帝也可能代表软弱和混乱——因为缺乏自律和规划，你的生活正在失去秩序，导致权威丧失。请反思你是过于强硬导致了反弹，还是过于软弱导致了失控。" 
        },
        { 
            name: "教皇 (The Hierophant)", 
            num: "V", 
            desc_up: "这是一张关于传统、信仰和学习的牌。当你感到迷茫时，寻求传统智慧、社会规范或专业人士的指引将非常有益。加入一个团队、组织或遵循既定的仪式感会给你带来力量。如果你正在考虑进修、考证或结婚，这都是一张非常积极的牌。顺从主流的价值观，按部就班地行事，你会获得内心的平静和外界的认可。", 
            desc_rev: "现在的你可能感到被传统的观念或僵化的体制所束缚。教皇逆位鼓励你打破常规，挑战权威，寻找属于你自己的独特道路。不要盲目听从所谓的‘大师’或‘长辈’的建议，他们的经验可能已不再适用于你的现状。这可能是一次观念上的叛逆，但对于你的个人成长来说，这种质疑精神是必要的。" 
        },
        { 
            name: "恋人 (The Lovers)", 
            num: "VI", 
            desc_up: "这是一个关于‘选择’与‘结合’的重要时刻。它通常预示着一段和谐、充满激情的亲密关系，或者在商业合作中达成了完美的共识。但更深层地，它代表了价值观的选择——你是选择面包还是爱情？听从你内心的渴望吧。当你的意识与潜意识达成统一，当你对他人的爱与对自己的爱达成平衡时，美好的事物自然会发生。", 
            desc_rev: "关系可能出现了裂痕，或者你正面临一个两难的抉择，而你可能会因为诱惑或恐惧做出错误的选择。这暗示了沟通的失败、价值观的冲突，或者因为逃避责任而导致的分离。逆位的恋人提醒你：如果你对自己都不诚实，就无法建立真正健康的关系。请检视这段关系中是否存在不平等或欺骗。" 
        },
        { 
            name: "战车 (The Chariot)", 
            num: "VII", 
            desc_up: "胜利属于坚持到底的人。战车代表着通过强大的意志力和自律，战胜内心的矛盾和外界的阻碍。尽管前路充满挑战和竞争，但只要你紧握缰绳，目标明确，快速行动，你就能冲过终点。这是一张行动力极强的牌，现在的你不能停滞不前，必须集中所有的精力去攻克难关。", 
            desc_rev: "这是一个失控的信号。你可能像脱缰的野马，被愤怒、冲动或恐惧等情绪所左右，导致方向迷失。强行推进计划可能会导致‘翻车’，你需要停下来重新调整节奏。逆位的战车也可能暗示你的意志力薄弱，遇到一点困难就想放弃。请反思：你是在驾驭生活，还是被生活的压力推着走？" 
        },
        { 
            name: "力量 (Strength)", 
            num: "VIII", 
            desc_up: "真正的力量不是展示肌肉，而是内心的韧性与包容。就像牌面上的女子温柔地抚摸狮子一样，你可以用以柔克刚的方式去驯服失控的局面或内心的野兽（恐惧、欲望）。面对困难时，请保持耐心、自信和同情心。你拥有的内在勇气比你想象的要强大得多，足以让你优雅地度过难关。", 
            desc_rev: "你可能因为自我怀疑而感到内心软弱，失去了面对挑战的信心。你可能正在被本能的恐惧、焦虑或嫉妒所压倒，导致在关键时刻选择了逃避。这张牌提醒你，承认自己的脆弱并不是失败，而是重建力量的开始。不要对自己太苛刻，找回你内心的平衡点，不要让消极情绪主宰了你的行动。" 
        },
        { 
            name: "隐士 (The Hermit)", 
            num: "IX", 
            desc_up: "请暂时从嘈杂的人群中抽离，享受一段独处的时光。现在的你不需要外界的建议，答案就在你心中。这是一段关于内省、寻找真理和精神指引的旅程。像隐士一样提着灯笼审视自己的内心，你会看清未来的方向。孤独并不可怕，它是智慧的温床。只有在安静中，你才能听到灵魂的低语。", 
            desc_rev: "过度的孤立可能导致了你与现实世界的脱节。你可能因为害怕社交、害怕受伤而拒绝他人的帮助，或者固执己见，听不进任何逆耳忠言。长期的封闭会让你陷入某种偏执或抑郁的情绪中。是时候走出洞穴了，尝试与外界建立连接，或者寻求值得信任的人的开导。" 
        },
        { 
            name: "命运之轮 (Wheel of Fortune)", 
            num: "X", 
            desc_up: "唯一不变的就是变化本身。命运的齿轮已经开始转动，不可抗拒的改变正在发生。通常这是一张幸运的牌，预示着机遇的降临、意外的惊喜或困境的转机。这不是关于你‘做’了什么，而是关于顺应。请相信宇宙的安排，抓住眼前的机会，顺水推舟，这个转折点将把你带向更广阔的人生阶段。", 
            desc_rev: "运势可能暂时陷入低谷，计划遭遇延误，或者突如其来的变故打乱了你的节奏。你可能在试图抵抗必须发生的改变，这种逆流而上的行为只会让你精疲力竭。请记住，低谷只是周期的一部分，并非永恒。保持耐心，不要强求结果，学会适应环境的变化，等待下一轮好运的到来。" 
        },
        { 
            name: "正义 (Justice)", 
            num: "XI", 
            desc_up: "种瓜得瓜，种豆得豆。现在的局面正是你过去行为和选择的公正结果。如果你一直诚实努力，现在将是获得回报和肯定的时候；如果你曾试图走捷径，现在可能面临清算。在做决定时，请务必保持绝对的理性、客观和诚实。对于涉及法律、合约或谈判的事务，将会得到一个公正的裁决。", 
            desc_rev: "你可能遭遇了不公的待遇，或者你自己正在试图逃避责任、掩盖真相。偏见和主观情绪蒙蔽了你的双眼，让你无法做出正确的判断。如果你在法律或合约中试图钻空子，最终可能会付出代价。这张牌警示你：不要以为可以欺骗因果，诚实面对自己的错误才是解决问题的唯一途径。" 
        },
        { 
            name: "倒吊人 (The Hanged Man)", 
            num: "XII", 
            desc_up: "换个角度看世界，你会得到全新的启示。目前的停滞不前其实是必要的‘暂停’。你可能需要做出某种牺牲，或者经历一段漫长的等待，才能获得精神上的成长。不要急于挣脱束缚，利用这段时间去反思、去冥想。有时候，‘无为’反而是最高级的‘有为’。放手控制，智慧自然降临。", 
            desc_rev: "这是一种无谓的牺牲，或者因为固执而陷入了僵局。你可能在扮演‘受害者’的角色，整天抱怨环境，却不愿做出实际的改变。你被困在旧有的思维模式中，抗拒去看清真相。赶紧从自我设限的思维中解脱出来吧，不要在一个没有结果的事情上继续浪费时间和精力。" 
        },
        { 
            name: "死神 (Death)", 
            num: "XIII", 
            desc_up: "不要被名字吓到，这通常象征着彻底的结束与新生的开始。某段关系、某个工作或某种旧的行为模式必须消亡，新的机会才能生长。就像凤凰涅槃，这是一个痛苦但必要的净化过程。不要留恋过去，拥抱这种必然的转变。清理掉生命中的‘死皮’，你将迎来更轻盈、更真实的自己。", 
            desc_rev: "你极其抗拒改变，紧抓着已经腐朽、不再滋养你的人或事不放。这种僵持只会延长你的痛苦，让你陷入停滞。你可能害怕未知，宁愿待在糟糕的舒适区里。请明白，该结束的终究会结束，拖延不仅无法改变结果，还会消耗你新生的能量。学会放手，是此刻的必修课。" 
        },
        { 
            name: "节制 (Temperance)", 
            num: "XIV", 
            desc_up: "这是一张关于平衡、疗愈与融合的牌。不要走极端，寻找中庸之道。现在的你需要像炼金术士一样，耐心地调和生活中对立的元素（如工作与生活、理性与感性）。通过沟通和妥协，原本矛盾的事物可以完美结合。保持内心的平静，循序渐进地改善现状，你会发现最适合自己的节奏。", 
            desc_rev: "生活失去了平衡。你可能过度放纵欲望，情绪失控，或者在两个选择之间反复横跳，犹豫不决。缺乏耐心导致你试图强行推进事情，结果反而搞砸了。人际关系中可能出现沟通不畅，因为双方都不愿妥协。请停下来，深呼吸，先找回你内心的平静，再处理外部的混乱。" 
        },
        { 
            name: "恶魔 (The Devil)", 
            num: "XV", 
            desc_up: "你可能正被物质欲望、不健康的关系或某种成瘾行为所束缚。虽然这给你带来了短暂的快感或安全感，但你其实失去了自由，成为了欲望的奴隶。这张牌揭示了人性中的阴暗面：贪婪、嫉妒、控制欲。请诚实地面对现状，你是否为了金钱或快感出卖了自己的灵魂？", 
            desc_rev: "这是一个觉醒的时刻。你开始意识到，那些束缚你的枷锁，其实是你自己戴上的；那个关着你的牢笼，其实门并没有上锁。现在你有机会打破恶性循环，重获自由，但这需要极大的勇气去面对现实的残酷。虽然过程痛苦，但你正在一步步摆脱黑暗的控制，走向独立。" 
        },
        { 
            name: "高塔 (The Tower)", 
            num: "XVI", 
            desc_up: "突如其来的剧变，如同雷电击中高塔。建立在虚假或不稳定基础上的事物（关系、事业、信念）将会在瞬间崩塌。虽然这看起来像一场灾难，让人震惊和痛苦，但它其实是宇宙的‘强制矫正’。它打破了你的幻象，让你看清了残酷但必要的真相。废墟之上，才是建立真实生活的开始。", 
            desc_rev: "你正在勉强维持着摇摇欲坠的现状，拒绝面对必然的崩溃。这只是在拖延痛苦的到来，且会让最终的坍塌更具破坏性。或许你刚经历了一场变故，但你选择视而不见，不愿意从中吸取教训。内部的压抑如果不释放，最终会造成身心的巨大伤害。接受现实吧，逃避是没有用的。" 
        },
        { 
            name: "星星 (The Star)", 
            num: "XVII", 
            desc_up: "在高塔的毁灭之后，星星带来了希望与宁静。这是一张治愈身心的牌，象征着灵感、清澈的洞察力和未来的美好愿景。无论之前经历了什么，现在是重拾信心的时候。相信未来，你的愿望有机会实现。向宇宙敞开你的心扉，你会感到一种深层的平静和被指引的感觉。你是被祝福的。", 
            desc_rev: "你可能失去了希望，感到悲观、无助，甚至愤世嫉俗。你可能好高骛远，追求虚幻的目标而忽视了现实的努力；或者因为缺乏自信，不敢去追求自己的梦想。这张牌逆位提示你：你与内心的源头断联了。不要放弃信仰，星星依然在云层之后闪耀，你需要擦亮心灵的眼睛去发现它。" 
        },
        { 
            name: "月亮 (The Moon)", 
            num: "XVIII", 
            desc_up: "前方道路模糊不清，潜意识深处的恐惧和不安开始浮现。事物并非表面看起来那样，此时要特别小心谎言、欺骗和自我幻觉。这是一个在黑暗中摸索的阶段，逻辑分析可能失效，你必须依靠你的直觉（或是梦境）来导航。面对你内心的‘阴影’，不要被想象出来的怪物吓倒。", 
            desc_rev: "迷雾逐渐散去，真相开始浮出水面。那些曾经让你感到恐惧和困惑的事物，现在变得清晰起来。你开始理解之前的焦虑是由什么引起的，并且不再被其控制。这是一个从噩梦中醒来的过程，虽然真相可能并不美好，但至少你不再被蒙在鼓里。保持清醒，危险正在远去。" 
        },
        { 
            name: "太阳 (The Sun)", 
            num: "XIX", 
            desc_up: "这是塔罗牌中最好的牌之一，象征着巨大的成功、快乐、活力和清晰。所有的阴霾一扫而空，事情变得清晰明朗，结果将超出你的预期。这是一个充满正能量的时刻，享受众人的瞩目，感受内心的喜悦吧。你的自信和热情将感染周围的人。无论是事业还是爱情，都将迎来阳光普照的日子。", 
            desc_rev: "太阳逆位依然是积极的，只是这份成功可能有所延迟，或者不如你预期的那么辉煌。你可能因为期望过高而感到小小的失落。另一方面，它也提醒你不要过度自信、傲慢或自我中心，那可能会灼伤他人。哪怕此时只有微弱的阳光，也请心存感激，因为黎明终将完全到来。" 
        },
        { 
            name: "审判 (Judgement)", 
            num: "XX", 
            desc_up: "这是一个觉醒和复活的时刻。你听到了内心的召唤，准备做出一个重大的、改变人生的决定。过去的努力现在到了结算的时候，你需要总结过去的经验教训，告别旧的自我，迎接新的人生阶段。对于悬而未决的事情，现在会有一个清晰的结论。清理包袱，轻装上阵。", 
            desc_rev: "你正在逃避关键的决定，因为害怕承担责任或面对改变。过去的阴影和遗憾在纠缠你，让你无法前进。你可能因为缺乏自我反省，而在重复同样的错误。如果不解决这些遗留问题，你就无法获得真正的解脱。不要假装听不到内心的声音，拖延只会让你错失良机。" 
        },
        { 
            name: "世界 (The World)", 
            num: "XXI", 
            desc_up: "完美的结局，宏大的达成。你完成了一个重要的生命周期，感到深深的圆满和整合。所有的努力都得到了回报，你与周围的世界达成了和谐。这不仅是终点，也是通往更高阶循环的起点。现在的你拥有广阔的视野，去庆祝你的成就吧，世界正在向你敞开怀抱。", 
            desc_rev: "你离成功仅一步之遥，却因为某种原因停滞不前。你可能感到不够圆满，或者心中仍有缺憾。这通常是因为你还没有完成某个必要的收尾工作，或者内心仍有某种执念放不下。请重新检查是否有什么细节被忽略，只有真正完成了这个课题，你才能无牵无挂地进入下一个篇章。" 
        }
    ];

    let deck = [];
    let isDrawing = false;
    const COOLDOWN_TIME = 4 * 60 * 60 * 1000; // 4小时，单位毫秒

    // 页面加载时检查状态
    window.onload = function() {
        checkCooldown();
    };

    function checkCooldown() {
        const lastTime = localStorage.getItem('tarot_last_time');
        const lastCardJson = localStorage.getItem('tarot_last_card');
        
        if (lastTime) {
            const elapsed = Date.now() - parseInt(lastTime);
            if (elapsed < COOLDOWN_TIME) {
                // 还在冷却中
                if (lastCardJson) {
                    // 如果有上次的卡牌数据，直接显示结果页
                    const card = JSON.parse(lastCardJson);
                    document.getElementById('section-start').classList.add('hidden');
                    // 直接调用显示结果，但不播放动画，立即显示
                    showResults(card, false); 
                    startTimer(COOLDOWN_TIME - elapsed);
                } else {
                    // 异常情况：有时间但无卡牌，显示倒计时禁止开始
                    disableStartButton(COOLDOWN_TIME - elapsed);
                }
            } else {
                // 冷却已过
                document.getElementById('start-btn').disabled = false;
            }
        }
    }

    function startTimer(remainingTime) {
        const timerDiv = document.getElementById('result-cooldown-msg');
        const restartBtn = document.getElementById('restart-btn');
        
        // 隐藏重开按钮，显示倒计时
        restartBtn.classList.add('hidden');
        timerDiv.classList.remove('hidden');

        function update() {
            if (remainingTime <= 0) {
                timerDiv.innerText = "冷却时间已过，可以开始新的占卜。";
                restartBtn.classList.remove('hidden');
                return;
            }
            
            const minutes = Math.floor(remainingTime / 60000);
            const seconds = Math.floor((remainingTime % 60000) / 1000);
            timerDiv.innerHTML = `塔罗牌充能中。<br>下次占卜倒计时：${minutes}分 ${seconds}秒`;
            
            remainingTime -= 1000;
            setTimeout(update, 1000);
        }
        update();
    }

    function disableStartButton(remainingTime) {
        const btn = document.getElementById('start-btn');
        const timerDiv = document.getElementById('cooldown-timer');
        btn.disabled = true;
        btn.innerText = "占卜指引已生效";
        timerDiv.classList.remove('hidden');

        function update() {
            if (remainingTime <= 0) {
                btn.disabled = false;
                btn.innerText = "开始抽取占卜指引";
                timerDiv.classList.add('hidden');
                return;
            }
            const minutes = Math.floor(remainingTime / 60000);
            const seconds = Math.floor((remainingTime % 60000) / 1000);
            timerDiv.innerText = `下次开启时间：${minutes}分 ${seconds}秒`;
            remainingTime -= 1000;
            setTimeout(update, 1000);
        }
        update();
    }

    function initGame() {
        document.getElementById('section-start').classList.add('hidden');
        document.getElementById('section-deck').classList.remove('hidden');
        deck = generateDeck();
        renderDeck();
    }

    function generateDeck() {
        let tempDeck = [...tarotData];
        for (let i = tempDeck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [tempDeck[i], tempDeck[j]] = [tempDeck[j], tempDeck[i]];
        }
        return tempDeck.map(card => ({
            ...card,
            reversed: Math.random() > 0.3,
            id: Math.random().toString(36).substr(2, 9)
        }));
    }

    function createCardElement(index) {
        let div = document.createElement('div');
        div.className = 'card-container';
        div.innerHTML = `
            <div class="card-face card-back"></div>
            <div class="card-face card-front">
                <div style="font-size:2rem">?</div>
            </div>
        `;
        return div;
    }

    function renderDeck() {
        const stage = document.getElementById('card-stage');
        stage.innerHTML = '';
        
        const totalCards = 22; 
        const cardElements = [];

        for(let i=0; i<totalCards; i++) {
            let cardEl = createCardElement(i);
            let randomRot = (Math.random() - 0.5) * 5;
            cardEl.style.transform = `translate(0, 0) rotate(${randomRot}deg)`;
            cardEl.onclick = function() { handleCardClick(this, i) };
            stage.appendChild(cardEl);
            cardElements.push(cardEl);
        }

        setTimeout(() => {
            shuffleAnimation(cardElements);
        }, 100);
    }

    function shuffleAnimation(elements) {
        let shuffleCount = 0;
        const maxShuffles = 5;

        function step() {
            if (shuffleCount >= maxShuffles) {
                elements.forEach(el => {
                    el.classList.remove('shuffling-state');
                    el.style.transform = `translate(0, 0) rotate(0deg)`;
                });
                setTimeout(spreadCards, 500); 
                return;
            }

            elements.forEach(el => {
                el.classList.add('shuffling-state');
                const x = (Math.random() - 0.5) * 60; 
                const y = (Math.random() - 0.5) * 60; 
                const r = (Math.random() - 0.5) * 30; 
                el.style.zIndex = Math.floor(Math.random() * 22);
                el.style.transform = `translate(${x}px, ${y}px) rotate(${r}deg)`;
            });

            shuffleCount++;
            setTimeout(step, 200); 
        }
        step();
    }

    function spreadCards() {
        const cards = document.querySelectorAll('.card-container');
        const total = cards.length;
        
        cards.forEach((c, index) => {
            c.style.zIndex = index; 
            const angleDeg = -60 + (index * (120 / (total - 1)));
            const offsetX = (index - (total - 1) / 2) * 40; 
            const offsetY = Math.abs(index - (total - 1) / 2) * 5;

            c.style.transform = `translate(${offsetX}px, ${offsetY}px) rotate(${angleDeg}deg)`;
            
            c.onmouseenter = function() {
                if(!c.getAttribute('data-selected')) {
                   c.style.transform = `translate(${offsetX}px, ${offsetY - 20}px) rotate(${angleDeg}deg) scale(1.1)`;
                }
            };
            c.onmouseleave = function() {
                if(!c.getAttribute('data-selected')) {
                   c.style.transform = `translate(${offsetX}px, ${offsetY}px) rotate(${angleDeg}deg)`;
                }
            };
        });
        
        isDrawing = true;
        document.getElementById('instruction').innerText = "洗牌完成，请凭直觉抽取一张";
    }

    function handleCardClick(element, visualIndex) {
        if (!isDrawing) return;
        if (element.getAttribute('data-selected')) return;

        isDrawing = false; // 只能选一张
        element.setAttribute('data-selected', 'true');
        
        // 飞出动画
        element.style.zIndex = 200;
        element.style.transition = 'transform 0.8s ease-in, opacity 0.8s ease-in';
        element.style.transform = `translate(0, -300px) scale(1.2)`;
        element.style.opacity = '0'; 

        // 获取结果
        let cardData = deck[visualIndex]; // 直接取对应index的牌，或者deck[0]也可以因为洗过了
        
        document.getElementById('instruction').innerText = "正在解析星象...";
        
        // 记录到 localStorage
        localStorage.setItem('tarot_last_time', Date.now());
        localStorage.setItem('tarot_last_card', JSON.stringify(cardData));

        setTimeout(() => {
            showResults(cardData, true);
        }, 1000);
    }

    // 显示结果
    // card: 牌数据
    // animate: 是否播放翻牌动画（如果是从缓存加载的，则设为false直接显示）
    function showResults(card, animate = true) {
        document.getElementById('section-deck').classList.add('hidden');
        document.getElementById('section-result').classList.remove('hidden');
        
        const container = document.getElementById('result-content');
        container.innerHTML = ''; 
        
        let wrapper = document.createElement('div');
        wrapper.className = 'result-box';
        if (!animate) wrapper.style.animation = 'none';
        
        let cardHtml = `
            <div style="display:flex; flex-direction: column; align-items:center; margin-bottom:15px; flex-shrink:0;">
                <div class="card-container result-card-visual" id="res-card-0">
                    <div class="card-face card-back"></div>
                    <div class="card-face card-front" style="background:${card.reversed ? '#e0e0e0' : '#f4e4bc'}">
                        <div class="card-num">${card.num}</div>
                        <div class="card-name">${card.name}</div>
                        <div style="margin-top:5px; font-size:0.8rem; color:${card.reversed ? '#c0392b' : '#27ae60'}">
                            ${card.reversed ? '逆位' : '正位'}
                        </div>
                    </div>
                </div>
                <div style="margin-top:10px; color: var(--primary); font-weight:bold;">占卜指引</div>
            </div>
            <div>
                <div class="keyword-box">${card.name} ${card.reversed ? '(逆位)' : '(正位)'}</div>
                <p style="line-height: 1.8; font-size: 1.05rem;">
                    ${card.reversed ? card.desc_rev : card.desc_up}
                </p>
            </div>
        `;
        
        wrapper.innerHTML = cardHtml;
        if (window.innerWidth > 600) {
            wrapper.style.display = 'flex';
            wrapper.style.alignItems = 'flex-start';
            wrapper.style.gap = '20px';
            wrapper.innerHTML = cardHtml; 
        }
        container.appendChild(wrapper);

        if (animate) {
            // 播放翻牌动画
            setTimeout(() => {
                let visualCard = document.getElementById(`res-card-0`);
                visualCard.classList.add(card.reversed ? 'flipped-reversed' : 'flipped');
            }, 500);
            
            // 开始倒计时
            startTimer(COOLDOWN_TIME);
        } else {
            // 直接显示翻开状态
            let visualCard = document.getElementById(`res-card-0`);
            visualCard.style.transition = 'none'; // 禁用动画
            visualCard.classList.add(card.reversed ? 'flipped-reversed' : 'flipped');
        }
    }
</script>

</body>
</html>
